<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Aptiv - Tableau de Bord</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            background: url('assets/output.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #bdbdbd;
            min-height: 100vh;
            padding: 0;
            display: flex;
            flex-direction: column;
            opacity: 0;
            animation: fadeInBody 0.8s ease forwards;
            position: relative;
            overflow: auto;
        }

        header {
            background: rgba(66, 66, 66, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 10px rgba(2, 136, 209, 0.5);
            border-bottom: 2px solid #0288d1;
            opacity: 0;
            animation: slideDown 0.6s ease forwards;
            position: relative;
            z-index: 1;
        }

        header::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: repeating-linear-gradient(
                45deg,
                rgba(211, 47, 47, 0.1) 0,
                rgba(211, 47, 47, 0.1) 10px,
                transparent 10px,
                transparent 20px
            );
            animation: pulseCables 4s infinite;
            z-index: -1;
        }

        header h1 {
            margin: 0;
            font-size: 24px;
            color: #d32f2f;
            text-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
            transform: scale(0.8);
            animation: scaleUp 0.5s ease forwards 0.2s;
            position: relative;
            z-index: 1;
        }

        #logout, .export-btn {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            transform: translateY(-10px);
            opacity: 0;
            animation: slideUpButton 0.6s ease forwards;
            box-shadow: 0 0 10px rgba(2, 136, 209, 0.5);
            position: relative;
            z-index: 1;
        }

        #logout:hover, .export-btn:hover {
            background: linear-gradient(to right, #b71c1c, #01579b);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(211, 47, 47, 0.7);
        }

        #logout:active, .export-btn:active {
            transform: scale(0.95);
        }

        a[href*="/defects"] {
            color: #0288d1;
            text-decoration: none;
            margin-right: 20px;
            transition: color 0.3s ease, transform 0.3s ease;
            transform: translateY(-10px);
            opacity: 0;
            animation: slideUpButton 0.6s ease forwards 0.2s;
            text-shadow: 0 0 5px rgba(2, 136, 209, 0.5);
            position: relative;
            z-index: 1;
        }

        a[href*="/defects"]:hover {
            color: #d32f2f;
            transform: scale(1.1);
        }

        .container {
            flex-grow: 1;
            padding: 30px;
            backdrop-filter: blur(5px);
            opacity: 0;
            animation: fadeIn 0.8s ease forwards 0.4s;
            position: relative;
            z-index: 1;
            min-height: 0;
        }

        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(66, 66, 66, 0.9);
            border-radius: 12px;
            padding: 15px 20px;
            margin: 10px;
            min-width: 150px;
            text-align: center;
            border: 2px solid #0288d1;
            box-shadow: 0 0 15px rgba(2, 136, 209, 0.3);
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.6s ease forwards;
            animation-delay: calc(var(--card-index) * 0.2s);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(211, 47, 47, 0.5);
        }

        .stat-value {
            font-size: 1.8em;
            color: #0288d1;
            margin: 5px 0;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(2, 136, 209, 0.5);
            animation: pulseValue 2s infinite ease-in-out;
        }

        .stat-label {
            font-size: 0.9em;
            color: #bdbdbd;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(66, 66, 66, 0.9);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(211, 47, 47, 0.3);
            opacity: 0;
            transform: scale(0.9);
            animation: scaleIn 0.6s ease forwards;
            animation-delay: calc(var(--chart-index) * 0.3s);
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 2px solid #0288d1;
            position: relative;
            z-index: 1;
        }

        .chart-container:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(2, 136, 209, 0.5);
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeIn 0.6s ease forwards 0.6s;
        }

        .chart-title {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
            animation: fadeIn 0.6s ease forwards;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .date-list-container {
            background: rgba(66, 66, 66, 0.9);
            border: 2px solid #0288d1;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .date-list-container h3 {
            color: #d32f2f;
            margin: 0 0 10px 0;
            font-size: 1em;
            text-shadow: 0 0 5px rgba(211, 47, 47, 0.5);
        }

        .month-group {
            margin-bottom: 10px;
        }

        .month-group h4 {
            color: #0288d1;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .date-item {
            padding: 5px 10px;
            background: rgba(97, 97, 97, 0.5);
            border-radius: 5px;
            margin: 2px 0;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .date-item:hover {
            background: rgba(2, 136, 209, 0.3);
        }

        .date-item.selected {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
        }

        .details-table-container {
            margin-top: 20px;
            background: rgba(66, 66, 66, 0.9);
            border-radius: 12px;
            padding: 10px;
            border: 2px solid #0288d1;
        }

        .details-table-container table {
            width: 100%;
            border-collapse: collapse;
            color: #bdbdbd;
        }

        .details-table-container th, .details-table-container td {
            border: 1px solid #616161;
            padding: 8px;
            text-align: left;
        }

        .details-table-container th {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
        }

        table.dataTable {
            width: 100% !important;
            border-radius: 12px;
            background: rgba(66, 66, 66, 0.9);
            color: #bdbdbd;
            border-collapse: collapse;
            opacity: 0;
            animation: fadeInTable 0.8s ease forwards 0.6s;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(2, 136, 209, 0.3);
        }

        table.dataTable thead {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
        }

        table.dataTable th, table.dataTable td {
            border: 1px solid #616161;
            padding: 10px;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease;
        }

        table.dataTable tbody tr {
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        table.dataTable tbody tr:hover {
            background: rgba(2, 136, 209, 0.1);
            transform: translateX(5px);
        }

        .dataTables_wrapper .dataTables_filter input {
            background: #616161;
            color: #bdbdbd;
            border: 1px solid #0288d1;
            border-radius: 5px;
            padding: 5px;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: #d32f2f;
            background: #424242;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: white !important;
            background: linear-gradient(to right, #d32f2f, #0288d1) !important;
            border: 1px solid #616161 !important;
            border-radius: 5px;
            margin: 0 3px;
            transition: all 0.3s ease;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: linear-gradient(to right, #b71c1c, #01579b) !important;
            border: 1px solid #d32f2f !important;
            transform: scale(1.1);
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:active {
            transform: scale(0.9);
        }

        .dataTables_wrapper::before {
            content: '';
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            border: 4px solid #d32f2f;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dataTables_wrapper.loading::before {
            display: block;
        }

        .report-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(66, 66, 66, 0.9);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #0288d1;
            box-shadow: 0 0 20px rgba(2, 136, 209, 0.5);
            max-width: 600px;
            width: 90%;
            color: #bdbdbd;
            z-index: 1000;
            opacity: 0;
            animation: scaleInReport 0.5s ease forwards;
            position: relative;
            overflow: hidden;
        }

        .report-panel::before {
            content: '';
            position: absolute;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: repeating-linear-gradient(
                45deg,
                rgba(211, 47, 47, 0.1) 0,
                rgba(211, 47, 47, 0.1) 10px,
                transparent 10px,
                transparent 20px
            );
            animation: pulseCables 4s infinite;
            z-index: -1;
        }

        .report-panel.active {
            display: block;
        }

        .report-panel h2 {
            color: #d32f2f;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
        }

        .report-panel p {
            font-size: 1em;
            line-height: 1.5;
            margin: 10px 0;
        }

        .report-panel select {
            background: #616161;
            color: #bdbdbd;
            border: 1px solid #0288d1;
            border-radius: 5px;
            padding: 5px;
            margin: 10px auto;
            display: block;
            width: 200px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23d32f2f' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .report-panel select:focus {
            outline: none;
            border-color: #d32f2f;
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.5);
        }

        .report-panel .close-report {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            margin: 15px auto 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(2, 136, 209, 0.5);
        }

        .report-panel .close-report:hover {
            background: linear-gradient(to right, #b71c1c, #01579b);
            transform: scale(1.05);
        }

        .report-panel .close-report:active {
            transform: scale(0.95);
        }

        .report-panel table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .report-panel th, .report-panel td {
            border: 1px solid #616161;
            padding: 8px;
            text-align: left;
        }

        .report-panel th {
            background: linear-gradient(to right, #d32f2f, #0288d1);
            color: white;
        }

        .hidden {
            display: none;
        }

        .car-animation {
            position: absolute;
            bottom: 20px;
            left: -120px;
            width: 120px;
            height: 60px;
            background: linear-gradient(to right, #0288d1, #b3e5fc);
            border: 2px solid #d32f2f;
            border-radius: 5px;
            animation: drive 12s linear infinite, vibrate 0.1s linear infinite;
            z-index: 10;
            box-shadow: 0 0 15px rgba(2, 136, 209, 0.5);
        }

        .smoke {
            position: absolute;
            bottom: 30px;
            left: -50px;
            width: 25px;
            height: 25px;
            background: linear-gradient(to top, #616161, #b3e5fc);
            border-radius: 50%;
            animation: smoke 2.5s linear infinite;
            z-index: 9;
        }

        .smoke:nth-child(2) {
            animation-delay: 0.6s;
            left: -60px;
        }

        .smoke:nth-child(3) {
            animation-delay: 1.2s;
            left: -70px;
        }

        @keyframes drive {
            0% { transform: translateX(-120px); }
            100% { transform: translateX(100vw); }
        }

        @keyframes vibrate {
            0% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
            100% { transform: translateY(0); }
        }

        @keyframes smoke {
            0% { transform: translateX(0) scale(1); opacity: 0.5; }
            100% { transform: translateX(-60px) translateY(-20px) scale(2.5); opacity: 0; }
        }

        @keyframes fadeInBody {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUpButton {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes scaleUp {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes pulseValue {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInTable {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes scaleInReport {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes pulseCables {
            0% { transform: scale(1); opacity: 0.1; }
            50% { transform: scale(1.1); opacity: 0.3; }
            100% { transform: scale(1); opacity: 0.1; }
        }

        footer {
            background: rgba(66, 66, 66, 0.9);
            text-align: center;
            padding: 10px;
            font-size: 13px;
            opacity: 0;
            animation: fadeIn 0.6s ease forwards 0.8s;
            color: #bdbdbd;
            border-top: 2px solid #0288d1;
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <header>
        <h1>Aptiv - Tableau de Bord</h1>
        <div>
            <a id="defectsLink" href="/defects?username=global&password=global123">Analyse des Défauts</a>
            <button id="logout">Déconnexion</button>
        </div>
    </header>

    <div class="container">
        <div id="statsContainer" class="stats-container">
            <div class="stat-card" style="--card-index: 0;">
                <div class="stat-label">Total Véhicules</div>
                <div class="stat-value" id="totalVehicles">0</div>
            </div>
            <div class="stat-card" style="--card-index: 1;">
                <div class="stat-label">Véhicules OK</div>
                <div class="stat-value" id="okVehicles">0</div>
            </div>
            <div class="stat-card" style="--card-index: 2;">
                <div class="stat-label">Véhicules Non OK</div>
                <div class="stat-value" id="notOkVehicles">0</div>
            </div>
        </div>

        <div id="exportButtons" class="export-buttons">
            <button class="export-btn" onclick="exportToCSV()">Exporter en CSV</button>
            <button class="export-btn" onclick="exportToExcel()">Exporter en Excel</button>
        </div>

        <div id="chartGrid" class="chart-grid">
            <div class="chart-container" id="statusChartContainer" style="--chart-index: 0;">
                <div class="chart-title">Statut des Véhicules</div>
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-container" id="distributionChartContainer" style="--chart-index: 1;">
                <div class="chart-title">Répartition des Véhicules (Par Heures)</div>
                <div class="date-list-container" id="dateListContainer">
                    <h3>Sélectionnez une date</h3>
                    <div id="dateList"></div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="distributionChart"></canvas>
                </div>
                <div class="details-table-container" id="detailsTableContainer" style="display: none;">
                    <h3>Détails des câbles</h3>
                    <table id="detailsTable">
                        <thead>
                            <tr>
                                <th>Fichier</th>
                                <th>Projet</th>
                                <th>CPN</th>
                                <th>Date</th>
                                <th>DS</th>
                                <th>Famille Machine</th>
                                <th>Matricule</th>
                                <th>NIV</th>
                                <th>Num</th>
                                <th>ROB</th>
                                <th>Statut</th>
                                <th>TE</th>
                                <th>TS</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="chart-container" id="projectChartContainer" style="--chart-index: 2;">
                <div class="chart-title">Répartition par Projet</div>
                <div class="chart-wrapper">
                    <canvas id="projectChart"></canvas>
                </div>
            </div>
        </div>

        <table id="vehicle-table" class="display">
            <thead>
                <tr>
                    <th>Fichier</th>
                    <th>Projet</th>
                    <th>CPN</th>
                    <th>Date</th>
                    <th>DS</th>
                    <th>Famille Machine</th>
                    <th>Matricule</th>
                    <th>NIV</th>
                    <th>Num</th>
                    <th>ROB</th>
                    <th>Statut</th>
                    <th>TE</th>
                    <th>TS</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div class="report-panel" id="reportPanel">
            <h2 id="reportTitle"></h2>
            <select id="statusViewSelect" onchange="updateStatusReport()">
                <option value="daily">Vue Journalière</option>
                <option value="shift">Vue par Shift</option>
                <option value="monthly">Vue par Mois</option>
                <option value="history">Historique</option>
            </select>
            <p id="reportContent"></p>
            <button class="close-report" onclick="closeReport()">Fermer</button>
        </div>
    </div>

    <div class="car-animation"></div>
    <div class="smoke"></div>
    <div class="smoke"></div>
    <div class="smoke"></div>

    <footer>
        © 2025 Aptiv - Tous droits réservés
    </footer>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let vehicleData = {
            byHour: {},
            byDay: {},
            byMonth: {},
            byModel: {},
            byShift: {},
            stats: { total: 0, ok: 0, notOk: 0 },
            raw: []
        };

        let statusChart, distributionChart, projectChart;
        let userProfile;
        let selectedDate = null;

        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'global';
        const password = urlParams.get('password') || 'global123';
        const authQuery = `?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;

        $.get(`/verify${authQuery}`, (data) => {
            if (data.success) {
                userProfile = data.profile;
                applyPermissions();
                loadVehicleData();
            } else {
                window.location.href = '/login';
            }
        }).fail(() => {
            window.location.href = '/login';
        });

        function applyPermissions() {
            document.getElementById('defectsLink').href += authQuery;

            if (userProfile === 'historique') {
                document.getElementById('statsContainer').classList.add('hidden');
                document.getElementById('exportButtons').classList.add('hidden');
                document.getElementById('chartGrid').classList.add('hidden');
                document.getElementById('vehicle-table').classList.add('hidden');
                document.getElementById('defectsLink').classList.add('hidden');
                window.location.href = `/history${authQuery}`;
            } else if (userProfile === 'defauts') {
                window.location.href = `/defects${authQuery}`;
            }
        }

        document.getElementById('logout').onclick = () => {
            window.location.href = `/logout${authQuery}`;
        };

        function exportToCSV() {
            let csvContent = "fichier,projet,cpn,de,ds,famillemachine,matricule,niv,num,rob,st,te,ts\n";
            vehicleData.raw.forEach(v => {
                csvContent += `${v.fichier},${v.projet},${v.cpn},${v.de},${v.ds},${v.famillemachine},${v.matricule},${v.niv},${v.num},${v.rob},${v.st},${v.te},${v.ts}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `vehicle_data_${new Date().toLocaleDateString('fr-FR')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToExcel() {
            window.location.href = `/export-excel${authQuery}`;
        }

        function parseDateDDMMYYYY(dateStr) {
            if (!dateStr) return null;

            const parts = dateStr.split(' ');
            const datePart = parts[0];
            const timePart = parts.length > 1 ? parts[1] : null;

            const dateComponents = datePart.split('/');
            if (dateComponents.length !== 3) {
                console.warn('Invalid date format (expected DD/MM/YYYY):', dateStr);
                return null;
            }

            const day = parseInt(dateComponents[0], 10);
            const month = parseInt(dateComponents[1], 10) - 1;
            const year = parseInt(dateComponents[2], 10);

            let date;
            if (timePart) {
                const timeComponents = timePart.split(':');
                const hours = parseInt(timeComponents[0], 10);
                const minutes = timeComponents.length > 1 ? parseInt(timeComponents[1], 10) : 0;
                date = new Date(year, month, day, hours, minutes);
            } else {
                date = new Date(year, month, day);
            }

            if (isNaN(date.getTime())) {
                console.warn('Invalid date parsed:', dateStr);
                return null;
            }
            return date;
        }

        function formatDateToDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function loadVehicleData() {
            $.ajax({
                url: `/api/vehicle-data${authQuery}`,
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    console.log('Données reçues:', data);
                    if (data.error) {
                        console.error('Erreur API:', data.error);
                        alert('Erreur lors du chargement des données.');
                        return;
                    }
                    vehicleData = data;

                    vehicleData.raw.forEach(v => {
                        try {
                            const date = parseDateDDMMYYYY(v.de);
                            if (!date) return;

                            const day = date.toISOString().split('T')[0];
                            if (!vehicleData.byDay[day]) {
                                vehicleData.byDay[day] = { total: 0, ok: 0, notOk: 0 };
                            }
                            vehicleData.byDay[day].total++;
                            if (v.st.toLowerCase() === 'ok') {
                                vehicleData.byDay[day].ok++;
                            } else {
                                vehicleData.byDay[day].notOk++;
                            }

                            const shift = Math.floor(date.getHours() / 8);
                            if (!vehicleData.byShift[shift]) {
                                vehicleData.byShift[shift] = { total: 0, ok: 0, notOk: 0 };
                            }
                            vehicleData.byShift[shift].total++;
                            if (v.st.toLowerCase() === 'ok') {
                                vehicleData.byShift[shift].ok++;
                            } else {
                                vehicleData.byShift[shift].notOk++;
                            }

                            const dateKey = formatDateToDDMMYYYY(date);
                            if (!vehicleData.byHour[dateKey]) {
                                vehicleData.byHour[dateKey] = { ok: 0, notOk: 0, total: 0 };
                            }
                            vehicleData.byHour[dateKey].total++;
                            if (v.st.toLowerCase() === 'ok') {
                                vehicleData.byHour[dateKey].ok++;
                            } else {
                                vehicleData.byHour[dateKey].notOk++;
                            }
                        } catch (e) {
                            console.error('Erreur analyse date:', e, 'pour la ligne:', v);
                        }
                    });

                    updateStats();
                    initializeCharts();
                    initializeTable();
                    populateDateList();
                },
                error: function(xhr, status, error) {
                    console.error('Erreur chargement données:', status, error);
                    alert('Erreur lors du chargement des données.');
                }
            });
        }

        function updateStats() {
            document.getElementById('totalVehicles').textContent = vehicleData.stats.total;
            document.getElementById('okVehicles').textContent = vehicleData.stats.ok;
            document.getElementById('notOkVehicles').textContent = vehicleData.stats.notOk;
        }

        function populateDateList() {
            const dateList = document.getElementById('dateList');
            const dates = [...new Set(vehicleData.raw.map(v => v.de))].filter(Boolean);
            const groupedByMonth = {};

            dates.forEach(dateStr => {
                const date = parseDateDDMMYYYY(dateStr);
                if (!date) return;

                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!groupedByMonth[monthYear]) {
                    groupedByMonth[monthYear] = [];
                }
                groupedByMonth[monthYear].push(formatDateToDDMMYYYY(date));
            });

            const monthNames = [
                'Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin',
                'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'
            ];

            Object.keys(groupedByMonth).sort().forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const monthGroup = document.createElement('div');
                monthGroup.className = 'month-group';
                monthGroup.innerHTML = `<h4>${monthNames[parseInt(month) - 1]} ${year}</h4>`;

                groupedByMonth[monthYear].sort().forEach(date => {
                    const dateItem = document.createElement('div');
                    dateItem.className = 'date-item';
                    dateItem.textContent = date;
                    dateItem.onclick = () => selectDate(date);
                    monthGroup.appendChild(dateItem);
                });

                dateList.appendChild(monthGroup);
            });
        }

        function selectDate(date) {
            selectedDate = date;
            const dateItems = document.querySelectorAll('.date-item');
            dateItems.forEach(item => {
                item.classList.remove('selected');
                if (item.textContent === date) {
                    item.classList.add('selected');
                }
            });
            updateDistributionChart();
            updateDetailsTable();
        }

        function updateDistributionChart() {
            if (!selectedDate) {
                distributionChart.options.plugins.title.display = true;
                distributionChart.options.plugins.title.text = 'Veuillez sélectionner une date';
                distributionChart.data = {
                    labels: [],
                    datasets: []
                };
                distributionChart.update();
                document.getElementById('detailsTableContainer').style.display = 'none';
                return;
            }

            let labels = [];
            let okData = [];
            let notOkData = [];

            let filteredData = vehicleData.raw.filter(v => v.de === selectedDate);

            if (filteredData.length === 0) {
                console.warn('Aucune donnée trouvée pour la date:', selectedDate);
                for (let hour = 0; hour < 24; hour++) {
                    labels.push(`${hour}h`);
                    okData.push(0);
                    notOkData.push(0);
                }
                distributionChart.options.plugins.title.display = true;
                distributionChart.options.plugins.title.text = 'Aucune donnée pour cette date';
                distributionChart.data = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'OK',
                            data: okData,
                            backgroundColor: '#d32f2f',
                            borderColor: '#d32f2f',
                            borderWidth: 1
                        },
                        {
                            label: 'Non OK',
                            data: notOkData,
                            backgroundColor: '#0288d1',
                            borderColor: '#0288d1',
                            borderWidth: 1
                        }
                    ]
                };
                distributionChart.update();
                document.getElementById('detailsTableContainer').style.display = 'none';
                return;
            }

            const dailyOk = filteredData.filter(v => v.st.toLowerCase() === 'ok').length;
            const dailyNotOk = filteredData.filter(v => v.st.toLowerCase() !== 'ok').length;
            const totalVehicles = dailyOk + dailyNotOk;
            const avgPerHour = totalVehicles > 0 ? Math.floor(totalVehicles / 24) : 0;
            const avgOkPerHour = dailyOk > 0 ? Math.floor(dailyOk / 24) : 0;
            const avgNotOkPerHour = dailyNotOk > 0 ? Math.floor(dailyNotOk / 24) : 0;

            let remainingOk = dailyOk;
            let remainingNotOk = dailyNotOk;

            for (let hour = 0; hour < 24; hour++) {
                labels.push(`${hour}h`);
                const okToAdd = Math.min(remainingOk, avgOkPerHour || (remainingOk > 0 ? 1 : 0));
                const notOkToAdd = Math.min(remainingNotOk, avgNotOkPerHour || (remainingNotOk > 0 ? 1 : 0));
                okData.push(okToAdd);
                notOkData.push(notOkToAdd);
                remainingOk -= okToAdd;
                remainingNotOk -= notOkToAdd;
            }

            let hourIndex = 0;
            while (remainingOk > 0 && hourIndex < 24) {
                okData[hourIndex]++;
                remainingOk--;
                hourIndex++;
            }
            hourIndex = 0;
            while (remainingNotOk > 0 && hourIndex < 24) {
                notOkData[hourIndex]++;
                remainingNotOk--;
                hourIndex++;
            }

            distributionChart.options.plugins.title.display = false;
            distributionChart.data = {
                labels: labels,
                datasets: [
                    {
                        label: 'OK',
                        data: okData,
                        backgroundColor: '#d32f2f',
                        borderColor: '#d32f2f',
                        borderWidth: 1
                    },
                    {
                        label: 'Non OK',
                        data: notOkData,
                        backgroundColor: '#0288d1',
                        borderColor: '#0288d1',
                        borderWidth: 1
                    }
                ]
            };
            distributionChart.update();
        }

        function updateDetailsTable() {
            const tbody = document.getElementById('detailsTableBody');
            tbody.innerHTML = '';

            if (!selectedDate) {
                document.getElementById('detailsTableContainer').style.display = 'none';
                return;
            }

            let filteredData = vehicleData.raw.filter(v => v.de === selectedDate);

            if (filteredData.length === 0) {
                document.getElementById('detailsTableContainer').style.display = 'none';
                return;
            }

            filteredData.forEach(v => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${v.fichier || ''}</td>
                    <td>${v.projet || ''}</td>
                    <td>${v.cpn || ''}</td>
                    <td>${v.de || ''}</td>
                    <td>${v.ds || ''}</td>
                    <td>${v.famillemachine || ''}</td>
                    <td>${v.matricule || ''}</td>
                    <td>${v.niv || ''}</td>
                    <td>${v.num || ''}</td>
                    <td>${v.rob || ''}</td>
                    <td>${v.st || ''}</td>
                    <td>${v.te || ''}</td>
                    <td>${v.ts || ''}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('detailsTableContainer').style.display = 'block';
        }

        function initializeCharts() {
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctxStatus, {
                type: 'pie',
                data: {
                    labels: ['OK', 'Non OK'],
                    datasets: [{
                        data: [vehicleData.stats.ok, vehicleData.stats.notOk],
                        backgroundColor: ['#d32f2f', '#0288d1'],
                        borderColor: ['#bdbdbd', '#bdbdbd'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#bdbdbd', font: { size: 14 } }
                        }
                    },
                    onClick: () => showReport('Statut des Véhicules', 'status')
                }
            });

            const ctxDistribution = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(ctxDistribution, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: '#bdbdbd' }, grid: { display: false } },
                        y: { stacked: true, ticks: { color: '#bdbdbd', beginAtZero: true }, grid: { color: 'rgba(189,189,189,0.2)' } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#bdbdbd', font: { size: 14 } }
                        },
                        title: {
                            display: true,
                            text: 'Veuillez sélectionner une date',
                            color: '#d32f2f',
                            font: { size: 14 },
                            padding: { top: 10, bottom: 30 }
                        }
                    },
                    onClick: () => showReport('Répartition des Véhicules', 'hourly')
                }
            });

            const ctxProject = document.getElementById('projectChart').getContext('2d');
            const projects = [...new Set(vehicleData.raw.map(v => v.projet))];
            const projectData = projects.map(projet => {
                const projData = vehicleData.raw.filter(v => v.projet === projet);
                return {
                    ok: projData.filter(v => v.st.toLowerCase() === 'ok').length,
                    notOk: projData.filter(v => v.st.toLowerCase() !== 'ok').length
                };
            });
            projectChart = new Chart(ctxProject, {
                type: 'bar',
                data: {
                    labels: projects,
                    datasets: [
                        {
                            label: 'OK',
                            data: projectData.map(d => d.ok),
                            backgroundColor: '#d32f2f',
                            borderColor: '#d32f2f',
                            borderWidth: 1
                        },
                        {
                            label: 'Non OK',
                            data: projectData.map(d => d.notOk),
                            backgroundColor: '#0288d1',
                            borderColor: '#0288d1',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#bdbdbd' }, grid: { display: false } },
                        y: { ticks: { color: '#bdbdbd', beginAtZero: true }, grid: { color: 'rgba(189,189,189,0.2)' } }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#bdbdbd', font: { size: 14 } }
                        }
                    },
                    onClick: () => showReport('Répartition par Projet', 'project')
                }
            });
        }

        function initializeTable() {
            $('#vehicle-table').DataTable({
                data: vehicleData.raw,
                columns: [
                    { data: 'fichier' },
                    { data: 'projet' },
                    { data: 'cpn' },
                    { data: 'de' },
                    { data: 'ds' },
                    { data: 'famillemachine' },
                    { data: 'matricule' },
                    { data: 'niv' },
                    { data: 'num' },
                    { data: 'rob' },
                    { data: 'st' },
                    { data: 'te' },
                    { data: 'ts' }
                ],
                pageLength: 10,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json'
                },
                responsive: true,
                order: [[3, 'desc']],
                scrollY: '400px',
                scrollCollapse: true,
                drawCallback: function () {
                    $('.dataTables_wrapper').removeClass('loading');
                }
            });
            $('.dataTables_wrapper').addClass('loading');
        }

        function showReport(title, type) {
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportPanel').classList.add('active');
            document.getElementById('statusViewSelect').value = 'daily';
            updateStatusReport(type);
        }

        function updateStatusReport(type) {
            const view = document.getElementById('statusViewSelect').value;
            let content = '';

            if (type === 'status') {
                if (view === 'daily') {
                    const today = new Date().toISOString().split('T')[0];
                    const todayData = vehicleData.byDay[today] || { total: 0, ok: 0, notOk: 0 };
                    content = `
                        <p>Total Véhicules: ${todayData.total}</p>
                        <p>Véhicules OK: ${todayData.ok}</p>
                        <p>Véhicules Non OK: ${todayData.notOk}</p>
                        <p>Taux de réussite: ${todayData.total ? Math.round((todayData.ok / todayData.total) * 100) : 0}%</p>
                    `;
                } else if (view === 'shift') {
                    content = '<table><tr><th>Shift</th><th>Total</th><th>OK</th><th>Non OK</th></tr>';
                    Object.entries(vehicleData.byShift).forEach(([shift, data]) => {
                        content += `<tr><td>Shift ${shift}</td><td>${data.total}</td><td>${data.ok}</td><td>${data.notOk}</td></tr>`;
                    });
                    content += '</table>';
                } else if (view === 'monthly') {
                    content = '<table><tr><th>Mois</th><th>Total</th><th>OK</th><th>Non OK</th></tr>';
                    Object.entries(vehicleData.byMonth).sort().forEach(([month, data]) => {
                        content += `<tr><td>${month}</td><td>${data.total}</td><td>${data.ok}</td><td>${data.notOk}</td></tr>`;
                    });
                    content += '</table>';
                } else {
                    content = `
                        <p>Total Véhicules: ${vehicleData.stats.total}</p>
                        <p>Véhicules OK: ${vehicleData.stats.ok}</p>
                        <p>Véhicules Non OK: ${vehicleData.stats.notOk}</p>
                        <p>Taux de réussite: ${vehicleData.stats.total ? Math.round((vehicleData.stats.ok / vehicleData.stats.total) * 100) : 0}%</p>
                    `;
                }
            } else if (type === 'hourly') {
                if (!selectedDate) {
                    content = '<p>Veuillez sélectionner une date.</p>';
                } else {
                    let filteredData = vehicleData.raw.filter(v => v.de === selectedDate);
                    content = '<table><tr><th>Heure</th><th>OK</th><th>Non OK</th></tr>';
                    const dailyOk = filteredData.filter(v => v.st.toLowerCase() === 'ok').length;
                    const dailyNotOk = filteredData.filter(v => v.st.toLowerCase() !== 'ok').length;
                    const avgOkPerHour = dailyOk > 0 ? Math.floor(dailyOk / 24) : 0;
                    const avgNotOkPerHour = dailyNotOk > 0 ? Math.floor(dailyNotOk / 24) : 0;

                    let remainingOk = dailyOk;
                    let remainingNotOk = dailyNotOk;

                    for (let hour = 0; hour < 24; hour++) {
                        const okToAdd = Math.min(remainingOk, avgOkPerHour || (remainingOk > 0 ? 1 : 0));
                        const notOkToAdd = Math.min(remainingNotOk, avgNotOkPerHour || (remainingNotOk > 0 ? 1 : 0));
                        content += `<tr><td>${hour}h</td><td>${okToAdd}</td><td>${notOkToAdd}</td></tr>`;
                        remainingOk -= okToAdd;
                        remainingNotOk -= notOkToAdd;
                    }
                    content += '</table>';
                }
            } else if (type === 'project') {
                content = '<table><tr><th>Projet</th><th>OK</th><th>Non OK</th></tr>';
                const projects = [...new Set(vehicleData.raw.map(v => v.projet))];
                projects.forEach(projet => {
                    const projData = vehicleData.raw.filter(v => v.projet === projet);
                    content += `<tr><td>${projet}</td><td>${projData.filter(v => v.st.toLowerCase() === 'ok').length}</td><td>${projData.filter(v => v.st.toLowerCase() !== 'ok').length}</td></tr>`;
                });
                content += '</table>';
            } else if (type === 'daily') {
                content = '<table><tr><th>Jour</th><th>Total</th><th>OK</th><th>Non OK</th></tr>';
                Object.entries(vehicleData.byDay).sort().forEach(([day, data]) => {
                    content += `<tr><td>${day}</td><td>${data.total}</td><td>${data.ok}</td><td>${data.notOk}</td></tr>`;
                });
                content += '</table>';
            } else if (type === 'monthly') {
                content = '<table><tr><th>Mois</th><th>Total</th><th>OK</th><th>Non OK</th></tr>';
                Object.entries(vehicleData.byMonth).sort().forEach(([month, data]) => {
                    content += `<tr><td>${month}</td><td>${data.total}</td><td>${data.ok}</td><td>${data.notOk}</td></tr>`;
                });
                content += '</table>';
            }

            document.getElementById('reportContent').innerHTML = content;
        }

        function closeReport() {
            document.getElementById('reportPanel').classList.remove('active');
        }
    </script>
</body>
</html>
